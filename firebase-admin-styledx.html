<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Amministrativa - Gestione Picnic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        :root {
            /* Colori Agricola Guss */
            --primary-color: #5A6F41; /* Verde oliva/salvia */
            --primary-dark: #3F4F2D;  /* Verde oliva scuro */
            --primary-light: #8A9F71; /* Verde oliva chiaro */
            --secondary-color: #9B7E58; /* Marrone caldo/terra */
            --secondary-dark: #7A5E38; /* Marrone scuro */
            --secondary-light: #BBA485; /* Marrone chiaro */
            --background-color: #F5F2E9; /* Beige/crema */
            --background-light: #FAF7F0; /* Beige chiaro */
            --accent-color: #A4BC7B; /* Verde chiaro/fresco */
            --text-color: #38301E; /* Marrone scuro quasi nero */
            --text-light: #6D6151; /* Marrone grigio */
            --white: #FFFFFF;
            
            /* Stili generali */
            --shadow: 0 4px 12px rgba(59, 50, 35, 0.08);
            --radius: 12px;
            --transition: all 0.3s ease;
            
            /* Stati ordini */
            --pending-color: #fff9c4;
            --pending-text: #f57f17;
            --completed-color: #e8f5e9;
            --completed-text: #2E7D32;
            --cancelled-color: #ffebee;
            --cancelled-text: #c62828;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--white);
            text-align: center;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background-color: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .login-container h2 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .login-container h2::after {
            content: '';
            position: absolute;
            height: 3px;
            width: 50px;
            background-color: var(--secondary-color);
            bottom: -5px;
            left: 0;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            background-color: var(--white);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        button i {
            margin-right: 0.5rem;
        }
        
        .button-secondary {
            background-color: var(--secondary-color);
        }
        
        .button-secondary:hover {
            background-color: var(--secondary-dark);
        }
        
        .button-danger {
            background-color: var(--cancelled-text);
        }
        
        .button-danger:hover {
            background-color: #b71c1c;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1.5rem;
        }
        
        .sidebar {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            height: fit-content;
        }
        
        .sidebar h3 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .sidebar h3::after {
            content: '';
            position: absolute;
            height: 3px;
            width: 50px;
            background-color: var(--secondary-color);
            bottom: -5px;
            left: 0;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.8rem;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: var(--text-color);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
        }
        
        .sidebar-menu a i {
            margin-right: 0.8rem;
            color: var(--secondary-color);
            font-size: 1.2rem;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--completed-color);
            color: var(--primary-dark);
        }
        
        .sidebar-menu a.active i {
            color: var(--primary-color);
        }
        
        .content {
            background-color: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            font-family: 'Playfair Display', serif;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            height: 3px;
            width: 50%;
            background-color: var(--secondary-color);
            bottom: -5px;
            left: 0;
        }
        
        .loader {
            border: 5px solid var(--background-light);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: var(--cancelled-text);
            padding: 1rem;
            background-color: var(--cancelled-color);
            border-radius: var(--radius);
            margin: 1rem 0;
            text-align: center;
        }
        
        /* Stili per dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background-color: var(--background-light);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(155, 126, 88, 0.1);
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(59, 50, 35, 0.1);
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stats-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        /* Stili per tabelle */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(59, 50, 35, 0.05);
        }
        
        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(155, 126, 88, 0.1);
        }
        
        th {
            background-color: var(--background-light);
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: var(--background-light);
        }
        
        /* Stili per ordini */
        .order-card {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border: 1px solid rgba(155, 126, 88, 0.1);
        }
        
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(59, 50, 35, 0.1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(155, 126, 88, 0.1);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        .order-id {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }
        
        .order-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .order-status {
            padding: 0.5rem 0.8rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .order-status.pending {
            background-color: var(--pending-color);
            color: var(--pending-text);
        }
        
        .order-status.completed {
            background-color: var(--completed-color);
            color: var(--completed-text);
        }
        
        .order-status.cancelled {
            background-color: var(--cancelled-color);
            color: var(--cancelled-text);
        }
        
        .order-details {
            margin-top: 1rem;
        }
        
        .order-customer {
            margin-bottom: 0.8rem;
        }
        
        .order-items {
            margin-top: 0.8rem;
        }
        
        .order-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1.5rem;
            gap: 0.8rem;
        }
        
        /* Stili per il form di prodotti e postazioni */
        .form-card {
            background-color: var(--background-light);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            border: 1px solid rgba(155, 126, 88, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-column {
            flex: 1;
        }
        
        /* Filtri per incassi */
        .revenue-filters {
            background-color: var(--background-light);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .filter-button {
            background-color: var(--white);
            color: var(--text-color);
            border: 1px solid rgba(155, 126, 88, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .filter-button:hover {
            background-color: var(--background-color);
            transform: translateY(-2px);
        }
        
        .filter-button.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }
        
        /* Grafici */
        .chart-container {
            background-color: var(--white);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            height: 400px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-container {
            background-color: var(--background-light);
            border-radius: var(--radius);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(155, 126, 88, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--background-light);
            z-index: 10;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 1.2rem;
            font-family: 'Playfair Display', serif;
            color: var(--primary-dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--text-color);
        }
        
        .modal-content {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(155, 126, 88, 0.2);
            text-align: right;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .order-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div id="login" class="login-container">
        <h2>Accesso Area Amministrativa</h2>
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Inserisci il tuo username">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Inserisci la tua password">
        </div>
        <button id="loginButton"><i class="fas fa-sign-in-alt"></i> Accedi</button>
        <div id="loginError" style="color: var(--cancelled-text); margin-top: 1rem; display: none;"></div>
    </div>
    
    <div id="dashboard" style="display: none;">
        <header>
            <h1><i class="fas fa-leaf"></i> Area Amministrativa - Agricola Guss Picnic</h1>
        </header>
        
        <div class="container">
            <div class="dashboard">
                <div class="sidebar">
                    <h3>Menu</h3>
                    <ul class="sidebar-menu">
                        <li><a class="active" onclick="showPage('dashboard-page')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li><a onclick="showPage('orders-page')"><i class="fas fa-shopping-basket"></i> Ordini</a></li>
                        <li><a onclick="showPage('products-page')"><i class="fas fa-utensils"></i> Prodotti</a></li>
                        <li><a onclick="showPage('locations-page')"><i class="fas fa-map-marker-alt"></i> Postazioni</a></li>
                        <li><a onclick="showPage('revenue-page')"><i class="fas fa-chart-line"></i> Incassi</a></li>
                        <li><a onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                    </ul>
                </div>
                
                <div class="content">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page active">
                        <h2 class="section-title">Dashboard</h2>
                        <p>Benvenuto nell'area amministrativa del sistema di ordinazione picnic di Agricola Guss.</p>
                        <div id="dashboard-stats">
                            <div class="loader" id="dashboard-loader"></div>
                        </div>
                    </div>
                    
                    <!-- Orders Page -->
                    <div id="orders-page" class="page">
                        <h2 class="section-title">Gestione Ordini</h2>
                        <div id="orders-filters">
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="order-status-filter">Filtra per stato:</label>
                                    <select id="order-status-filter" onchange="filterOrders()">
                                        <option value="all">Tutti gli ordini</option>
                                        <option value="pending">In attesa</option>
                                        <option value="completed">Completati</option>
                                        <option value="cancelled">Annullati</option>
                                    </select>
                                </div>
                                <div class="form-column">
                                    <label for="order-date-filter">Filtra per data:</label>
                                    <input type="date" id="order-date-filter" onchange="filterOrders()">
                                </div>
                            </div>
                        </div>
                        <div id="ordersList">
                            <div class="loader" id="orders-loader"></div>
                        </div>
                    </div>
                    
                    <!-- Products Page -->
                    <div id="products-page" class="page">
                        <h2 class="section-title">Gestione Prodotti</h2>
                        <button onclick="showProductForm()"><i class="fas fa-plus"></i> Aggiungi Nuovo Prodotto</button>
                        
                        <div id="product-form" class="form-card" style="display: none;">
                            <h3 id="product-form-title">Aggiungi Nuovo Prodotto</h3>
                            <input type="hidden" id="product-id">
                            <div class="form-group">
                                <label for="product-name">Nome Prodotto:</label>
                                <input type="text" id="product-name" placeholder="Nome del prodotto">
                            </div>
                            <div class="form-group">
                                <label for="product-description">Descrizione:</label>
                                <textarea id="product-description" rows="3" placeholder="Descrizione del prodotto"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="product-price">Prezzo (€):</label>
                                    <input type="number" id="product-price" step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="form-column">
                                    <label for="product-image">URL Immagine:</label>
                                    <input type="text" id="product-image" placeholder="https://...">
                                </div>
                            </div>
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="hideProductForm()" class="button-secondary"><i class="fas fa-times"></i> Annulla</button>
                                <button onclick="saveProduct()"><i class="fas fa-save"></i> Salva Prodotto</button>
                            </div>
                        </div>
                        
                        <div id="productsList" style="margin-top: 1.5rem;">
                            <div class="loader" id="products-loader"></div>
                        </div>
                    </div>
                    
                    <!-- Locations Page -->
                    <div id="locations-page" class="page">
                        <h2 class="section-title">Gestione Postazioni</h2>
                        <button onclick="showLocationForm()"><i class="fas fa-plus"></i> Aggiungi Nuova Postazione</button>
                        
                        <div id="location-form" class="form-card" style="display: none;">
                            <h3 id="location-form-title">Aggiungi Nuova Postazione</h3>
                            <input type="hidden" id="location-id">
                            <div class="form-row">
                                <div class="form-column">
                                    <label for="location-number">Numero Postazione:</label>
                                    <input type="number" id="location-number" min="1" placeholder="1">
                                </div>
                                <div class="form-column">
                                    <label for="location-name">Nome/Descrizione:</label>
                                    <input type="text" id="location-name" placeholder="Es: Sotto il grande ulivo">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="location-status">Stato:</label>
                                <select id="location-status">
                                    <option value="available">Disponibile</option>
                                    <option value="maintenance">In Manutenzione</option>
                                    <option value="reserved">Riservata</option>
                                </select>
                            </div>
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="hideLocationForm()" class="button-secondary"><i class="fas fa-times"></i> Annulla</button>
                                <button onclick="saveLocation()"><i class="fas fa-save"></i> Salva Postazione</button>
                            </div>
                        </div>
                        
                        <div id="locationsList" style="margin-top: 1.5rem;">
                            <div class="loader" id="locations-loader"></div>
                        </div>
                    </div>
                    
                    <!-- Revenue Page -->
                    <div id="revenue-page" class="page">
                        <h2 class="section-title">Analisi Incassi</h2>
                        
                        <div class="revenue-filters">
                            <button class="filter-button active" id="daily-filter" onclick="switchRevenueFilter('daily')">Giornaliero</button>
                            <button class="filter-button" id="weekly-filter" onclick="switchRevenueFilter('weekly')">Settimanale</button>
                            <button class="filter-button" id="monthly-filter" onclick="switchRevenueFilter('monthly')">Mensile</button>
                            <button class="filter-button" id="yearly-filter" onclick="switchRevenueFilter('yearly')">Annuale</button>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stats-card">
                                <div class="stats-value" id="revenue-value">€0.00</div>
                                <div class="stats-label" id="revenue-label">Incasso Totale</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-value" id="orders-value">0</div>
                                <div class="stats-label" id="orders-label">Ordini</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-value" id="avg-value">€0.00</div>
                                <div class="stats-label">Valore Medio Ordine</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-value" id="products-value">0</div>
                                <div class="stats-label">Prodotti Venduti</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="productChart"></canvas>
                        </div>
                        
                        <div id="revenueDetails">
                            <h3 class="section-title">Dettaglio Ordini</h3>
                            <div class="loader" id="revenue-loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal per visualizzare i dettagli dell'ordine -->
    <div id="orderModal" class="modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">Dettagli Ordine</div>
                <button class="modal-close" onclick="document.getElementById('orderModal').style.display = 'none';">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content" id="orderModalContent"></div>
            <div class="modal-footer">
                <button onclick="document.getElementById('orderModal').style.display = 'none';"><i class="fas fa-times"></i> Chiudi</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script type="module">
        // Salva postazione (nuova o esistente)
        window.saveLocation = function() {
            const locationKey = document.getElementById('location-id').value;
            const number = parseInt(document.getElementById('location-number').value);
            const name = document.getElementById('location-name').value;
            const status = document.getElementById('location-status').value;
            
            // Validazione
            if (isNaN(number) || number <= 0) {
                alert('Il numero della postazione deve essere un numero maggiore di zero!');
                return;
            }
            
            if (!name) {
                alert('Il nome/descrizione della postazione è obbligatorio!');
                return;
            }
            
            // Verifica che non ci sia già una postazione con lo stesso numero
            if (!locationKey) {
                const existingLocation = window.locations.find(l => l.number === number);
                if (existingLocation) {
                    alert(`Esiste già una postazione con il numero ${number}. Scegli un altro numero!`);
                    return;
                }
            }
            
            // Prepara la postazione
            const location = {
                number: number,
                name: name,
                status: status
            };
            
            let locationRef;
            
            if (locationKey) {
                // Aggiornamento postazione esistente
                locationRef = ref(database, `locations/${locationKey}`);
                update(locationRef, location)
                    .then(() => {
                        alert('Postazione aggiornata con successo!');
                        hideLocationForm();
                    })
                    .catch((error) => {
                        console.error("Errore durante l'aggiornamento della postazione:", error);
                        alert("Si è verificato un errore durante l'aggiornamento della postazione.");
                    });
            } else {
                // Aggiunta nuova postazione
                locationRef = ref(database, 'locations');
                push(locationRef, location)
                    .then(() => {
                        alert('Nuova postazione aggiunta con successo!');
                        hideLocationForm();
                    })
                    .catch((error) => {
                        console.error("Errore durante l'aggiunta della postazione:", error);
                        alert("Si è verificato un errore durante l'aggiunta della postazione.");
                    });
            }
        };
        
        // Elimina postazione
        window.deleteLocation = function(locationKey) {
            if (confirm('Sei sicuro di voler eliminare questa postazione?')) {
                const locationRef = ref(database, `locations/${locationKey}`);
                
                remove(locationRef)
                    .then(() => {
                        alert('Postazione eliminata con successo!');
                    })
                    .catch((error) => {
                        console.error("Errore durante l'eliminazione della postazione:", error);
                        alert("Si è verificato un errore durante l'eliminazione della postazione.");
                    });
            }
        };
        
        /*** REVENUE FUNCTIONS ***/
        
        // Cambia il tipo di filtro per gli incassi
        window.switchRevenueFilter = function(filterType) {
            // Aggiorna il filtro attivo
            document.querySelectorAll('.filter-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${filterType}-filter`).classList.add('active');
            
            window.currentRevenueFilter = filterType;
            loadRevenueData(filterType);
        };
        
        // Inizializza i grafici
        window.initCharts = function() {
            // Grafico incassi
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            window.revenueChart = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Incassi',
                        backgroundColor: 'rgba(90, 111, 65, 0.6)',
                        borderColor: 'rgba(90, 111, 65, 1)',
                        borderWidth: 1,
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Andamento degli Incassi',
                            font: {
                                size: 16,
                                family: '"Playfair Display", serif'
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico prodotti venduti
            const productCtx = document.getElementById('productChart').getContext('2d');
            window.productChart = new Chart(productCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        backgroundColor: [
                            'rgba(90, 111, 65, 0.7)',
                            'rgba(155, 126, 88, 0.7)',
                            'rgba(164, 188, 123, 0.7)',
                            'rgba(187, 164, 133, 0.7)',
                            'rgba(63, 79, 45, 0.7)',
                            'rgba(138, 159, 113, 0.7)',
                            'rgba(122, 94, 56, 0.7)',
                            'rgba(109, 97, 81, 0.7)'
                        ],
                        borderColor: [
                            'rgba(90, 111, 65, 1)',
                            'rgba(155, 126, 88, 1)',
                            'rgba(164, 188, 123, 1)',
                            'rgba(187, 164, 133, 1)',
                            'rgba(63, 79, 45, 1)',
                            'rgba(138, 159, 113, 1)',
                            'rgba(122, 94, 56, 1)',
                            'rgba(109, 97, 81, 1)'
                        ],
                        borderWidth: 1,
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Prodotti Più Venduti',
                            font: {
                                size: 16,
                                family: '"Playfair Display", serif'
                            }
                        },
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        };
        
        // Carica i dati degli incassi
        window.loadRevenueData = function(filterType) {
            const loader = document.getElementById('revenue-loader');
            loader.style.display = 'block';
            
            // Reference agli ordini
            const ordersRef = ref(database, 'orders');
            
            // Ottieni i dati in tempo reale
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.values(data) : [];
                
                // Filtra per ordini completati
                const completedOrders = orders.filter(order => order.status === 'completed');
                
                // Aggiorna le statistiche e i grafici in base al tipo di filtro
                updateRevenueStats(completedOrders, filterType);
                
                loader.style.display = 'none';
            });
        };
        
        // Aggiorna le statistiche degli incassi
        window.updateRevenueStats = function(orders, filterType) {
            // Filtra gli ordini in base al periodo selezionato
            const filteredOrders = filterOrdersByPeriod(orders, filterType);
            
            // Calcola le statistiche
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total, 0);
            const totalOrders = filteredOrders.length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            // Calcola il numero totale di prodotti venduti
            const totalProducts = filteredOrders.reduce((sum, order) => {
                return sum + order.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
            }, 0);
            
            // Aggiorna i valori visualizzati
            document.getElementById('revenue-value').textContent = `€${totalRevenue.toFixed(2)}`;
            document.getElementById('orders-value').textContent = totalOrders;
            document.getElementById('avg-value').textContent = `€${avgOrderValue.toFixed(2)}`;
            document.getElementById('products-value').textContent = totalProducts;
            
            // Aggiorna i testi dei label in base al filtro
            let periodLabel = '';
            switch(filterType) {
                case 'daily':
                    periodLabel = 'Giornaliero';
                    break;
                case 'weekly':
                    periodLabel = 'Settimanale';
                    break;
                case 'monthly':
                    periodLabel = 'Mensile';
                    break;
                case 'yearly':
                    periodLabel = 'Annuale';
                    break;
            }
            
            document.getElementById('revenue-label').textContent = `Incasso ${periodLabel}`;
            document.getElementById('orders-label').textContent = `Ordini ${periodLabel}`;
            
            // Aggiorna i grafici
            updateRevenueChart(filteredOrders, filterType);
            updateProductChart(filteredOrders);
            
            // Aggiorna la tabella degli ordini
            updateRevenueDetails(filteredOrders);
        };
        
        // Filtra gli ordini in base al periodo
        window.filterOrdersByPeriod = function(orders, filterType) {
            const now = new Date();
            let startDate = new Date();
            
            switch(filterType) {
                case 'daily':
                    // Oggi
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'weekly':
                    // Ultima settimana
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'monthly':
                    // Ultimo mese
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'yearly':
                    // Ultimo anno
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            return orders.filter(order => new Date(order.date) >= startDate);
        };
        
        // Aggiorna il grafico degli incassi
        window.updateRevenueChart = function(orders, filterType) {
            let labels = [];
            let data = [];
            
            switch(filterType) {
                case 'daily':
                    // Ore del giorno
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                        data.push(0);
                    }
                    
                    // Raggruppa per ora
                    orders.forEach(order => {
                        const orderDate = new Date(order.date);
                        const hour = orderDate.getHours();
                        data[hour] += order.total;
                    });
                    break;
                    
                case 'weekly':
                    // Ultimi 7 giorni
                    const dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
                    const today = new Date();
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(today.getDate() - i);
                        labels.push(dayNames[date.getDay()]);
                        data.push(0);
                    }
                    
                    // Raggruppa per giorno
                    orders.forEach(order => {
                        const orderDate = new Date(order.date);
                        const daysAgo = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                        if (daysAgo >= 0 && daysAgo < 7) {
                            data[6 - daysAgo] += order.total;
                        }
                    });
                    break;
                    
                case 'monthly':
                    // Ultime 4 settimane
                    for (let i = 4; i >= 1; i--) {
                        labels.push(`Settimana ${i}`);
                        data.push(0);
                    }
                    
                    // Raggruppa per settimana del mese
                    const monthAgo = new Date();
                    monthAgo.setMonth(now.getMonth() - 1);
                    
                    orders.forEach(order => {
                        const orderDate = new Date(order.date);
                        if (orderDate >= monthAgo) {
                            const daysAgo = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));
                            const weekIndex = Math.min(3, Math.floor(daysAgo / 7));
                            data[3 - weekIndex] += order.total;
                        }
                    });
                    break;
                    
                case 'yearly':
                    // Ultimi 12 mesi
                    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                    
                    for (let i = 11; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(today.getMonth() - i);
                        labels.push(monthNames[date.getMonth()]);
                        data.push(0);
                    }
                    
                    // Raggruppa per mese
                    orders.forEach(order => {
                        const orderDate = new Date(order.date);
                        const yearAgo = new Date();
                        yearAgo.setFullYear(today.getFullYear() - 1);
                        
                        if (orderDate >= yearAgo) {
                            const monthsAgo = (today.getFullYear() - orderDate.getFullYear()) * 12 + 
                                              (today.getMonth() - orderDate.getMonth());
                            if (monthsAgo >= 0 && monthsAgo < 12) {
                                data[11 - monthsAgo] += order.total;
                            }
                        }
                    });
                    break;
            }
            
            // Aggiorna il grafico
            window.revenueChart.data.labels = labels;
            window.revenueChart.data.datasets[0].data = data;
            window.revenueChart.update();
        };
        
        // Aggiorna il grafico dei prodotti
        window.updateProductChart = function(orders) {
            // Conta i prodotti venduti
            const productCounts = {};
            
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (productCounts[item.name]) {
                        productCounts[item.name] += item.quantity;
                    } else {
                        productCounts[item.name] = item.quantity;
                    }
                });
            });
            
            // Converti in array e ordina
            const sortedProducts = Object.entries(productCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // Prendi solo i primi 8
            
            const labels = sortedProducts.map(product => product[0]);
            const data = sortedProducts.map(product => product[1]);
            
            // Aggiorna il grafico
            window.productChart.data.labels = labels;
            window.productChart.data.datasets[0].data = data;
            window.productChart.update();
        };
        
        // Aggiorna i dettagli degli incassi
        window.updateRevenueDetails = function(orders) {
            const revenueDetails = document.getElementById('revenueDetails');
            
            if (orders.length === 0) {
                revenueDetails.innerHTML = `
                    <h3 class="section-title">Dettaglio Ordini</h3>
                    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; color: var(--secondary-light);"></i>
                        <p>Nessun ordine trovato per il periodo selezionato.</p>
                    </div>
                `;
                return;
            }
            
            // Ordina gli ordini per data (più recenti prima)
            orders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let detailsHTML = `
                <h3 class="section-title">Dettaglio Ordini</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID Ordine</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Totale</th>
                            <th>Dettagli</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                detailsHTML += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customer.name}</td>
                        <td>${new Date(order.date).toLocaleString('it-IT')}</td>
                        <td>€${order.total.toFixed(2)}</td>
                        <td>
                            <button onclick="viewOrderDetails('${order.firebaseKey}')" style="padding: 0.3rem 0.6rem;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            detailsHTML += `
                    </tbody>
                </table>
            `;
            
            revenueDetails.innerHTML = detailsHTML;
        };
        
        // Inizializza la pagina caricando i dati del dashboard all'apertura
        // Definisco le funzioni del window object
        window.login = window.login;
        window.logout = window.logout;
        window.showPage = window.showPage;
        window.loadDashboardData = window.loadDashboardData;
        window.loadOrders = window.loadOrders;
        window.filterOrders = window.filterOrders;
        window.displayOrders = window.displayOrders;
        window.viewOrderDetails = window.viewOrderDetails;
        window.updateOrderStatus = window.updateOrderStatus;
        window.loadProducts = window.loadProducts;
        window.showProductForm = window.showProductForm;
        window.hideProductForm = window.hideProductForm;
        window.editProduct = window.editProduct;
        window.saveProduct = window.saveProduct;
        window.deleteProduct = window.deleteProduct;
        window.loadLocations = window.loadLocations;
        window.showLocationForm = window.showLocationForm;
        window.hideLocationForm = window.hideLocationForm;
        window.editLocation = window.editLocation;
        window.saveLocation = window.saveLocation;
        window.deleteLocation = window.deleteLocation;
        window.switchRevenueFilter = window.switchRevenueFilter;
        window.initCharts = window.initCharts;
        window.loadRevenueData = window.loadRevenueData;
        window.updateRevenueStats = window.updateRevenueStats;
        window.filterOrdersByPeriod = window.filterOrdersByPeriod;
        window.updateRevenueChart = window.updateRevenueChart;
        window.updateProductChart = window.updateProductChart;
        window.updateRevenueDetails = window.updateRevenueDetails;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM completamente caricato");
            
            // Assicuriamoci che il bottone di login funzioni correttamente
            document.getElementById('loginButton').addEventListener('click', function() {
                console.log("Click sul bottone di login");
                login();
            });
            
            // Aggiungiamo un ascoltatore per il tasto Invio nella pagina di login
            document.getElementById('password').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    console.log("Premuto Enter sulla password");
                    login();
                }
            });
            
            // Ascoltatore per chiudere modal se si clicca fuori
            window.onclick = function(event) {
                const modal = document.getElementById('orderModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        });
         Importa le librerie Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, update, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Configurazione Firebase
        const firebaseConfig = {
            databaseURL: "https://picnic-4467e-default-rtdb.europe-west1.firebasedatabase.app/"
        };
        
        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Credenziali amministratore
        window.ADMIN_USERNAME = "admin";
        window.ADMIN_PASSWORD = "admin123";
        
        // Variabili per tracking delle risorse
        window.orders = [];
        window.products = [];
        window.locations = [];
        window.currentRevenueFilter = 'daily';
        window.revenueChart = null;
        window.productChart = null;
        
        // Funzione di login
        window.login = function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            if (username === window.ADMIN_USERNAME && password === window.ADMIN_PASSWORD) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Carica i dati iniziali
                loadDashboardData();
                loadOrders();
                loadProducts();
                loadLocations();
                
                // Inizializza i grafici
                initCharts();
            } else {
                loginError.textContent = 'Username o password non validi';
                loginError.style.display = 'block';
            }
        };
        
        // Funzione di logout
        window.logout = function() {
            document.getElementById('login').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        };
        
        // Funzione per mostrare una pagina del dashboard
        window.showPage = function(pageId) {
            // Nascondi tutte le pagine
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostra la pagina selezionata
            document.getElementById(pageId).classList.add('active');
            
            // Aggiorna la classe active nel menu
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
                
                if (link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                }
            });
            
            // Ricarica i dati quando si cambia pagina
            if (pageId === 'dashboard-page') {
                loadDashboardData();
            } else if (pageId === 'orders-page') {
                loadOrders();
            } else if (pageId === 'products-page') {
                loadProducts();
            } else if (pageId === 'locations-page') {
                loadLocations();
            } else if (pageId === 'revenue-page') {
                loadRevenueData(window.currentRevenueFilter);
            }
        };
        
        /*** DASHBOARD FUNCTIONS ***/
        
        // Carica i dati del dashboard
        window.loadDashboardData = function() {
            console.log("Caricamento dati dashboard");
            const loader = document.getElementById('dashboard-loader');
            loader.style.display = 'block';
            
            const statsContainer = document.getElementById('dashboard-stats');
            
            // Reference agli ordini
            const ordersRef = ref(database, 'orders');
            
            // Ottieni i dati in tempo reale
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.entries(data).map(([key, value]) => ({
                    ...value,
                    firebaseKey: key
                })) : [];
                
                // Statistiche di base
                const pendingOrders = orders.filter(order => order.status === 'pending').length;
                const completedOrders = orders.filter(order => order.status === 'completed').length;
                const totalRevenue = orders
                    .filter(order => order.status !== 'cancelled')
                    .reduce((sum, order) => sum + (order.total || 0), 0);
                
                // Reference ai prodotti e postazioni
                const productsRef = ref(database, 'products');
                const locationsRef = ref(database, 'locations');
                
                // Ottieni conteggio prodotti
                get(productsRef).then((productsSnapshot) => {
                    const productsCount = productsSnapshot.exists() ? Object.keys(productsSnapshot.val()).length : 0;
                    
                    // Ottieni conteggio postazioni
                    get(locationsRef).then((locationsSnapshot) => {
                        const locationsCount = locationsSnapshot.exists() ? Object.keys(locationsSnapshot.val()).length : 0;
                        
                        // Calcola data odierna per ordini di oggi
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const todayOrders = orders.filter(order => {
                            const orderDate = new Date(order.date);
                            orderDate.setHours(0, 0, 0, 0);
                            return orderDate.getTime() === today.getTime();
                        }).length;
                        
                        // Costruisci il contenuto HTML per le statistiche
                        const statsHTML = `
                            <div class="stats-grid">
                                <div class="stats-card">
                                    <div class="stats-value">${pendingOrders}</div>
                                    <div class="stats-label">Ordini in attesa</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value">${completedOrders}</div>
                                    <div class="stats-label">Ordini completati</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value">${todayOrders}</div>
                                    <div class="stats-label">Ordini di oggi</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value">€${totalRevenue.toFixed(2)}</div>
                                    <div class="stats-label">Incasso totale</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value">${productsCount}</div>
                                    <div class="stats-label">Prodotti attivi</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-value">${locationsCount}</div>
                                    <div class="stats-label">Postazioni totali</div>
                                </div>
                            </div>
                            
                            <h3 class="section-title">Ultimi Ordini</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Ordine</th>
                                        <th>Cliente</th>
                                        <th>Totale</th>
                                        <th>Stato</th>
                                        <th>Data</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orders.slice(0, 5).map(order => `
                                        <tr>
                                            <td>${order.id}</td>
                                            <td>${order.customer.name}</td>
                                            <td>€${order.total.toFixed(2)}</td>
                                            <td>
                                                <span class="order-status ${order.status}">
                                                    ${order.status === 'pending' ? 'In attesa' : 
                                                      order.status === 'completed' ? 'Completato' : 'Annullato'}
                                                </span>
                                            </td>
                                            <td>${new Date(order.date).toLocaleString('it-IT')}</td>
                                            <td>
                                                <button onclick="viewOrderDetails('${order.firebaseKey || ''}')" style="padding: 0.3rem 0.6rem;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        
                        statsContainer.innerHTML = statsHTML;
                        loader.style.display = 'none';
                    });
                });
            });
        };
        
        /*** ORDERS FUNCTIONS ***/
        
        // Carica gli ordini
        window.loadOrders = function() {
            const loader = document.getElementById('orders-loader');
            loader.style.display = 'block';
            
            const ordersList = document.getElementById('ordersList');
            
            // Reference agli ordini
            const ordersRef = ref(database, 'orders');
            
            // Ottieni i dati in tempo reale
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                window.orders = data ? Object.entries(data).map(([key, value]) => ({
                    ...value,
                    firebaseKey: key
                })) : [];
                
                // Ordina gli ordini per data (più recenti prima)
                window.orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Applica i filtri correnti
                filterOrders();
                
                loader.style.display = 'none';
            });
        };
        
        // Filtra gli ordini
        window.filterOrders = function() {
            const statusFilter = document.getElementById('order-status-filter').value;
            const dateFilter = document.getElementById('order-date-filter').value;
            
            let filteredOrders = [...window.orders];
            
            // Filtra per stato
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }
            
            // Filtra per data
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filterDate.setHours(0, 0, 0, 0);
                
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date);
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate.getTime() === filterDate.getTime();
                });
            }
            
            // Aggiorna la visualizzazione
            displayOrders(filteredOrders);
        };
        
        // Visualizza gli ordini filtrati
        window.displayOrders = function(orders) {
            const ordersList = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p>Nessun ordine trovato.</p>';
                return;
            }
            
            let ordersHTML = '';
            
            orders.forEach(order => {
                const statusText = order.status === 'pending' ? 'In attesa' : 
                                  order.status === 'completed' ? 'Completato' : 'Annullato';
                
                ordersHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">${order.id}</div>
                            <div class="order-date">${new Date(order.date).toLocaleString('it-IT')}</div>
                            <div class="order-status ${order.status}">${statusText}</div>
                        </div>
                        <div class="order-details">
                            <div class="order-customer">
                                <strong>Cliente:</strong> ${order.customer.name} | <strong>Telefono:</strong> ${order.customer.phone}
                            </div>
                            <div class="order-location">
                                <strong>Postazione:</strong> ${order.location.name}
                            </div>
                            <div class="order-total">
                                <strong>Totale:</strong> €${order.total.toFixed(2)}
                            </div>
                            ${order.notes ? `<div class="order-notes"><strong>Note:</strong> ${order.notes}</div>` : ''}
                        </div>
                        <div class="order-actions">
                            <button onclick="viewOrderDetails('${order.firebaseKey}')"><i class="fas fa-eye"></i> Dettagli</button>
                            ${order.status === 'pending' ? `
                                <button onclick="updateOrderStatus('${order.firebaseKey}', 'completed')" style="background-color: var(--completed-text);">
                                    <i class="fas fa-check"></i> Completa
                                </button>
                                <button onclick="updateOrderStatus('${order.firebaseKey}', 'cancelled')" class="button-danger">
                                    <i class="fas fa-times"></i> Annulla
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            ordersList.innerHTML = ordersHTML;
        };
        
        // Visualizza i dettagli dell'ordine in un modal
        window.viewOrderDetails = function(orderKey) {
            const order = window.orders.find(o => o.firebaseKey === orderKey);
            
            if (!order) return;
            
            const modal = document.getElementById('orderModal');
            const modalContent = document.getElementById('orderModalContent');
            
            const statusText = order.status === 'pending' ? 'In attesa' : 
                              order.status === 'completed' ? 'Completato' : 'Annullato';
            
            let itemsHTML = '';
            order.items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                itemsHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>€${item.price.toFixed(2)}</td>
                        <td>€${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <p><strong>ID Ordine:</strong> ${order.id}</p>
                    <p><strong>Data:</strong> ${new Date(order.date).toLocaleString('it-IT')}</p>
                    <p><strong>Stato:</strong> <span class="order-status ${order.status}">${statusText}</span></p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Informazioni Cliente</h4>
                    <p><strong>Nome:</strong> ${order.customer.name}</p>
                    <p><strong>Telefono:</strong> ${order.customer.phone}</p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Postazione</h4>
                    <p>${order.location.name}</p>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Prodotti Ordinati</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Prodotto</th>
                                <th>Quantità</th>
                                <th>Prezzo Unitario</th>
                                <th>Totale</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Totale Ordine:</strong></td>
                                <td><strong>€${order.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${order.notes ? `
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Note</h4>
                    <p>${order.notes}</p>
                </div>
                ` : ''}
                
                ${order.status === 'pending' ? `
                <div style="text-align: right; margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="updateOrderStatus('${order.firebaseKey}', 'completed')" style="background-color: var(--completed-text);">
                        <i class="fas fa-check"></i> Completa Ordine
                    </button>
                    <button onclick="updateOrderStatus('${order.firebaseKey}', 'cancelled')" class="button-danger">
                        <i class="fas fa-times"></i> Annulla Ordine
                    </button>
                </div>
                ` : ''}
            `;
            
            modal.style.display = 'flex';
        };
        
        // Aggiorna lo stato dell'ordine
        window.updateOrderStatus = function(orderKey, newStatus) {
            const orderRef = ref(database, `orders/${orderKey}`);
            
            update(orderRef, {
                status: newStatus
            }).then(() => {
                // Chiudi modal se aperto
                document.getElementById('orderModal').style.display = 'none';
                
                // Mostra messaggio di successo
                alert(`Stato dell'ordine aggiornato a: ${newStatus === 'completed' ? 'Completato' : 'Annullato'}`);
            }).catch((error) => {
                console.error("Errore durante l'aggiornamento dello stato:", error);
                alert("Si è verificato un errore durante l'aggiornamento dello stato dell'ordine.");
            });
        };
        
        /*** PRODUCTS FUNCTIONS ***/
        
        // Carica i prodotti
        window.loadProducts = function() {
            const loader = document.getElementById('products-loader');
            loader.style.display = 'block';
            
            const productsList = document.getElementById('productsList');
            
            // Reference ai prodotti
            const productsRef = ref(database, 'products');
            
            // Ottieni i dati in tempo reale
            onValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                window.products = data ? Object.entries(data).map(([key, value]) => ({
                    ...value,
                    firebaseKey: key
                })) : [];
                
                if (window.products.length === 0) {
                    productsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-utensils" style="font-size: 3rem; margin-bottom: 1rem; color: var(--secondary-light);"></i>
                            <p>Nessun prodotto trovato. Aggiungi il tuo primo prodotto!</p>
                        </div>
                    `;
                } else {
                    let productsHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Descrizione</th>
                                    <th>Prezzo</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    window.products.forEach(product => {
                        productsHTML += `
                            <tr>
                                <td>${product.id}</td>
                                <td>${product.name}</td>
                                <td>${product.description}</td>
                                <td>€${product.price.toFixed(2)}</td>
                                <td style="white-space: nowrap;">
                                    <button onclick="editProduct('${product.firebaseKey}')" style="padding: 0.3rem 0.6rem; background-color: #1976D2;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteProduct('${product.firebaseKey}')" style="padding: 0.3rem 0.6rem;" class="button-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    productsHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    productsList.innerHTML = productsHTML;
                }
                
                loader.style.display = 'none';
            });
        };
        
        // Mostra form prodotto (per aggiunta)
        window.showProductForm = function() {
            document.getElementById('product-form').style.display = 'block';
            document.getElementById('product-form-title').textContent = 'Aggiungi Nuovo Prodotto';
            document.getElementById('product-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-image').value = '';
        };
        
        // Nascondi form prodotto
        window.hideProductForm = function() {
            document.getElementById('product-form').style.display = 'none';
        };
        
        // Prepara form per modifica prodotto
        window.editProduct = function(productKey) {
            const product = window.products.find(p => p.firebaseKey === productKey);
            
            if (!product) return;
            
            document.getElementById('product-form-title').textContent = 'Modifica Prodotto';
            document.getElementById('product-id').value = productKey;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-image').value = product.image;
            
            document.getElementById('product-form').style.display = 'block';
        };
        
        // Salva prodotto (nuovo o esistente)
        window.saveProduct = function() {
            const productKey = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const image = document.getElementById('product-image').value;
            
            // Validazione
            if (!name) {
                alert('Il nome del prodotto è obbligatorio!');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                alert('Il prezzo deve essere un numero maggiore di zero!');
                return;
            }
            
            // Prepara il prodotto
            const product = {
                id: productKey ? window.products.find(p => p.firebaseKey === productKey).id : generateProductId(),
                name: name,
                description: description,
                price: price,
                image: image || "https://via.placeholder.com/300x200.png?text=" + name.replace(/ /g, '+')
            };
            
            let productRef;
            
            if (productKey) {
                // Aggiornamento prodotto esistente
                productRef = ref(database, `products/${productKey}`);
                update(productRef, product)
                    .then(() => {
                        alert('Prodotto aggiornato con successo!');
                        hideProductForm();
                    })
                    .catch((error) => {
                        console.error("Errore durante l'aggiornamento del prodotto:", error);
                        alert("Si è verificato un errore durante l'aggiornamento del prodotto.");
                    });
            } else {
                // Aggiunta nuovo prodotto
                productRef = ref(database, 'products');
                push(productRef, product)
                    .then(() => {
                        alert('Nuovo prodotto aggiunto con successo!');
                        hideProductForm();
                    })
                    .catch((error) => {
                        console.error("Errore durante l'aggiunta del prodotto:", error);
                        alert("Si è verificato un errore durante l'aggiunta del prodotto.");
                    });
            }
        };
        
        // Elimina prodotto
        window.deleteProduct = function(productKey) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                const productRef = ref(database, `products/${productKey}`);
                
                remove(productRef)
                    .then(() => {
                        alert('Prodotto eliminato con successo!');
                    })
                    .catch((error) => {
                        console.error("Errore durante l'eliminazione del prodotto:", error);
                        alert("Si è verificato un errore durante l'eliminazione del prodotto.");
                    });
            }
        };
        
        // Genera ID prodotto
        function generateProductId() {
            const maxId = window.products.length > 0 
                ? Math.max(...window.products.map(p => parseInt(p.id)))
                : 0;
            return (maxId + 1).toString();
        }
        
        /*** LOCATIONS FUNCTIONS ***/
        
        // Carica le postazioni
        window.loadLocations = function() {
            const loader = document.getElementById('locations-loader');
            loader.style.display = 'block';
            
            const locationsList = document.getElementById('locationsList');
            
            // Reference alle postazioni
            const locationsRef = ref(database, 'locations');
            
            // Ottieni i dati in tempo reale
            onValue(locationsRef, (snapshot) => {
                const data = snapshot.val();
                window.locations = data ? Object.entries(data).map(([key, value]) => ({
                    ...value,
                    firebaseKey: key
                })) : [];
                
                // Ordina le postazioni per numero
                window.locations.sort((a, b) => a.number - b.number);
                
                if (window.locations.length === 0) {
                    locationsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                            <i class="fas fa-map-marker-alt" style="font-size: 3rem; margin-bottom: 1rem; color: var(--secondary-light);"></i>
                            <p>Nessuna postazione trovata. Aggiungi la tua prima postazione!</p>
                        </div>
                    `;
                } else {
                    let locationsHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Numero</th>
                                    <th>Nome/Descrizione</th>
                                    <th>Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    window.locations.forEach(location => {
                        const statusText = location.status === 'available' ? 'Disponibile' : 
                                          location.status === 'maintenance' ? 'In Manutenzione' : 'Riservata';
                        
                        const statusClass = location.status === 'available' ? 'completed' : 
                                           location.status === 'maintenance' ? 'cancelled' : 'pending';
                        
                        locationsHTML += `
                            <tr>
                                <td>${location.number}</td>
                                <td>${location.name}</td>
                                <td><span class="order-status ${statusClass}">${statusText}</span></td>
                                <td style="white-space: nowrap;">
                                    <button onclick="editLocation('${location.firebaseKey}')" style="padding: 0.3rem 0.6rem; background-color: #1976D2;">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteLocation('${location.firebaseKey}')" style="padding: 0.3rem 0.6rem;" class="button-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    locationsHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    locationsList.innerHTML = locationsHTML;
                }
                
                loader.style.display = 'none';
            });
        };
        
        // Mostra form postazione (per aggiunta)
        window.showLocationForm = function() {
            document.getElementById('location-form').style.display = 'block';
            document.getElementById('location-form-title').textContent = 'Aggiungi Nuova Postazione';
            document.getElementById('location-id').value = '';
            document.getElementById('location-number').value = '';
            document.getElementById('location-name').value = '';
            document.getElementById('location-status').value = 'available';
        };
        
        // Nascondi form postazione
        window.hideLocationForm = function() {
            document.getElementById('location-form').style.display = 'none';
        };
        
        // Prepara form per modifica postazione
        window.editLocation = function(locationKey) {
            const location = window.locations.find(l => l.firebaseKey === locationKey);
            
            if (!location) return;
            
            document.getElementById('location-form-title').textContent = 'Modifica Postazione';
            document.getElementById('location-id').value = locationKey;
            document.getElementById('location-number').value = location.number;
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-status').value = location.status || 'available';
            
            document.getElementById('location-form').style.display = 'block';
        };
        
        //