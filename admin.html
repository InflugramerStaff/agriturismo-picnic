<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Amministrativa - Gestione Picnic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5A6F41;
            --primary-dark: #3F4F2D;
            --primary-light: #8A9F71;
            --secondary-color: #9B7E58;
            --secondary-dark: #7A5E38;
            --secondary-light: #BBA485;
            --background-color: #F5F2E9;
            --background-light: #FAF7F0;
            --accent-color: #A4BC7B;
            --text-color: #38301E;
            --text-light: #6D6151;
            --white: #FFFFFF;
            --shadow: 0 4px 12px rgba(59, 50, 35, 0.08);
            --radius: 12px;
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        header { background-color: var(--primary-color); color: var(--white); text-align: center; padding: 1rem; box-shadow: var(--shadow); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .login-container { max-width: 400px; margin: 100px auto; background-color: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 0.8rem 1rem; border: 1px solid #e0e0e0; border-radius: var(--radius); font-size: 1rem; background-color: var(--white); transition: var(--transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
        button { background-color: var(--primary-color); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: var(--radius); cursor: pointer; font-size: 1rem; font-weight: 500; transition: var(--transition); }
        button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .dashboard { display: grid; grid-template-columns: 250px 1fr; gap: 1rem; }
        .sidebar { background-color: var(--white); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-menu li { margin-bottom: 0.5rem; }
        .sidebar-menu a { display: block; padding: 0.5rem; color: var(--text-color); text-decoration: none; border-radius: var(--radius); transition: var(--transition); cursor: pointer; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background-color: var(--primary-light); color: var(--white); }
        .content { background-color: var(--white); padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow); }
        .page { display: none; }
        .page.active { display: block; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #e53935; padding: 1rem; background-color: #ffebee; border-radius: var(--radius); margin: 1rem 0; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 0.75rem; text-align: left; }
        th { background-color: var(--background-light); font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: rgba(90, 111, 65, 0.1); }
        .card { background-color: var(--background-light); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1rem; }
        .order-status.pending { background-color: #fff9c4; color: #f57f17; }
        .order-status.completed { background-color: #e8f5e9; color: #2E7D32; }
        .order-status.cancelled { background-color: #ffebee; color: #c62828; }
        .charts-container { margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .chart-card { background-color: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; min-height: 300px; display: flex; flex-direction: column; }
        .chart-card h4 { margin-bottom: 1rem; text-align: center; }
        .order-card { background-color: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; border-left: 5px solid var(--primary-color); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
        .order-id { font-weight: 600; font-size: 1.1rem; color: var(--primary-dark); }
        .order-date { font-size: 0.9rem; color: var(--text-light); }
        .order-status { padding: 0.3rem 0.8rem; border-radius: var(--radius); font-size: 0.85rem; font-weight: 500; text-transform: capitalize; }
        .order-details > div { margin-bottom: 0.5rem; }
        .order-customer, .order-location, .order-total, .order-notes { font-size: 0.95rem; }
        .order-actions { margin-top: 1rem; text-align: right; }
        .order-actions button { margin-left: 0.5rem; }
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .form-column { flex: 1; min-width: 200px; }
        .product-form { background-color: var(--background-light); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 1.5rem; box-shadow: var(--shadow); }
    </style>
</head>
<body>
    <div id="login" class="login-container">
        <h2>Accesso Area Amministrativa</h2>
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Inserisci il tuo username">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Inserisci la tua password">
        </div>
        <button onclick="login()">Accedi</button>
        <div id="loginError" style="color: red; margin-top: 1rem; display: none;"></div>
    </div>
    
    <div id="dashboard" style="display: none;">
        <header><h1>Area Amministrativa - Gestione Picnic</h1></header>
        <div class="container">
            <div class="dashboard">
                <div class="sidebar">
                    <h3>Menu</h3>
                    <ul class="sidebar-menu">
                        <li><a class="active" onclick="showPage('dashboard-page')">Dashboard</a></li>
                        <li><a onclick="showPage('orders-page')">Ordini</a></li>
                        <li><a onclick="showPage('products-page')">Prodotti</a></li>
                        <li><a onclick="showPage('locations-page')">Postazioni</a></li>
                        <li><a onclick="logout()">Logout</a></li>
                    </ul>
                </div>
                <div class="content">
                    <div id="dashboard-page" class="page active">
                        <h2>Dashboard</h2>
                        <p>Benvenuto nell'area amministrativa del sistema di ordinazione picnic.</p>
                        <div id="dashboard-stats"><div class="loader" id="dashboard-loader"></div></div>
                        <div id="charts-section" style="margin-top: 2rem; display: none;">
                            <h3 style="margin-bottom: 1rem;">Andamento Ordini e Fatturato</h3>
                            <div class="charts-container">
                                <div class="chart-card"><h4>Ordini Settimanali</h4><canvas id="weeklyOrdersChart"></canvas></div>
                                <div class="chart-card"><h4>Fatturato Settimanale (€)</h4><canvas id="weeklyRevenueChart"></canvas></div>
                                <div class="chart-card"><h4>Ordini Mensili</h4><canvas id="monthlyOrdersChart"></canvas></div>
                                <div class="chart-card"><h4>Fatturato Mensile (€)</h4><canvas id="monthlyRevenueChart"></canvas></div>
                                <div class="chart-card"><h4>Ordini Annuali</h4><canvas id="annualOrdersChart"></canvas></div>
                                <div class="chart-card"><h4>Fatturato Annuale (€)</h4><canvas id="annualRevenueChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div id="orders-page" class="page">
                        <h2>Gestione Ordini</h2>
                        <div id="orders-filters" class="form-row" style="align-items: flex-end; margin-bottom: 1.5rem;">
                            <div class="form-column"><label for="order-status-filter">Filtra per stato:</label><select id="order-status-filter" onchange="filterOrders()"><option value="all">Tutti</option><option value="pending">In attesa</option><option value="completed">Completati</option><option value="cancelled">Annullati</option></select></div>
                            <div class="form-column"><label for="order-date-filter">Filtra per data:</label><input type="date" id="order-date-filter" onchange="filterOrders()"></div>
                            <div class="form-column" style="flex: 0 0 auto;"><button onclick="clearOrderFilters()">Rimuovi Filtri</button></div>
                        </div>
                        <div id="ordersList"><div class="loader" id="orders-loader"></div></div>
                    </div>
                    <div id="products-page" class="page">
                        <h2>Gestione Prodotti</h2>
                        <button onclick="showProductForm()" style="margin-bottom: 1rem;">Aggiungi Nuovo Prodotto</button>
                        <div id="product-form" class="product-form" style="display: none;">
                            <h3 id="product-form-title">Aggiungi Nuovo Prodotto</h3><input type="hidden" id="product-id">
                            <div class="form-group"><label for="product-name">Nome Prodotto:</label><input type="text" id="product-name"></div>
                            <div class="form-group"><label for="product-description">Descrizione:</label><textarea id="product-description" rows="3"></textarea></div>
                            <div class="form-row"><div class="form-column"><label for="product-price">Prezzo (€):</label><input type="number" id="product-price" step="0.01" min="0"></div><div class="form-column"><label for="product-image">URL Immagine:</label><input type="text" id="product-image"></div></div>
                            <div style="margin-top: 1rem;"><button onclick="saveProduct()">Salva</button><button onclick="hideProductForm()" style="background-color: #757575;">Annulla</button></div>
                        </div>
                        <div id="productsList"><div class="loader" id="products-loader"></div></div>
                    </div>
                    <div id="locations-page" class="page">
                        <h2>Gestione Postazioni</h2>
                        <button onclick="showLocationForm()" style="margin-bottom: 1rem;">Aggiungi Nuova Postazione</button>
                        <div id="location-form" class="product-form" style="display: none;">
                            <h3 id="location-form-title">Aggiungi Nuova Postazione</h3><input type="hidden" id="location-id">
                            <div class="form-row"><div class="form-column"><label for="location-number">Numero Postazione:</label><input type="number" id="location-number" min="1"></div><div class="form-column"><label for="location-name">Nome/Descrizione:</label><input type="text" id="location-name"></div></div>
                            <div class="form-group"><label for="location-status">Stato:</label><select id="location-status"><option value="available">Disponibile</option><option value="maintenance">In Manutenzione</option><option value="reserved">Riservata</option></select></div>
                            <div style="margin-top: 1rem;"><button onclick="saveLocation()">Salva</button><button onclick="hideLocationForm()" style="background-color: #757575;">Annulla</button></div>
                        </div>
                        <div id="locationsList"><div class="loader" id="locations-loader"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; overflow-y: auto;">
        <div style="background-color: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <h3>Dettagli Ordine</h3><div id="orderModalContent"></div>
            <div style="text-align: right; margin-top: 1rem;"><button onclick="document.getElementById('orderModal').style.display = 'none';">Chiudi</button></div>
        </div>
    </div>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://picnic-4467e-default-rtdb.europe-west1.firebasedatabase.app/" };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    window.ADMIN_USERNAME = "admin";
    window.ADMIN_PASSWORD = "admin123";
    window.orders = [];
    window.products = [];
    window.locations = [];
    window.chartInstances = {};

    // Variabili per gestire gli unsubscribe dei listener Firebase
    let unsubscribeDashboardOrders = null;
    let unsubscribeOrdersPage = null;
    let unsubscribeProductsPage = null;
    let unsubscribeLocationsPage = null;

    window.login = function() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');
        if (username === window.ADMIN_USERNAME && password === window.ADMIN_PASSWORD) {
            document.getElementById('login').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            localStorage.setItem('isAdminLoggedIn', 'true');
            showPage('dashboard-page');
        } else {
            loginError.textContent = 'Username o password non validi';
            loginError.style.display = 'block';
        }
    };

    window.logout = function() {
        localStorage.removeItem('isAdminLoggedIn');
        // Annulla l'iscrizione a tutti i listener attivi
        if (unsubscribeDashboardOrders) unsubscribeDashboardOrders();
        if (unsubscribeOrdersPage) unsubscribeOrdersPage();
        if (unsubscribeProductsPage) unsubscribeProductsPage();
        if (unsubscribeLocationsPage) unsubscribeLocationsPage();
        unsubscribeDashboardOrders = null;
        unsubscribeOrdersPage = null;
        unsubscribeProductsPage = null;
        unsubscribeLocationsPage = null;

        Object.keys(window.chartInstances).forEach(chartId => destroyChart(chartId));

        document.getElementById('login').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        if (document.getElementById('loginError')) document.getElementById('loginError').style.display = 'none';
    };

    window.showPage = function(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        const activePage = document.getElementById(pageId);
        if (activePage) activePage.classList.add('active');

        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('onclick')?.includes(pageId)) {
                link.classList.add('active');
            }
        });

        // Pulisci i listener delle altre pagine
        if (pageId !== 'dashboard-page' && unsubscribeDashboardOrders) {
            unsubscribeDashboardOrders();
            unsubscribeDashboardOrders = null;
            Object.keys(window.chartInstances).forEach(chartId => destroyChart(chartId));
            const chartsSection = document.getElementById('charts-section');
            if(chartsSection) chartsSection.style.display = 'none'; // Nascondi grafici se non sulla dashboard
        }
        if (pageId !== 'orders-page' && unsubscribeOrdersPage) {
            unsubscribeOrdersPage();
            unsubscribeOrdersPage = null;
        }
        if (pageId !== 'products-page' && unsubscribeProductsPage) {
            unsubscribeProductsPage();
            unsubscribeProductsPage = null;
        }
        if (pageId !== 'locations-page' && unsubscribeLocationsPage) {
            unsubscribeLocationsPage();
            unsubscribeLocationsPage = null;
        }

        if (pageId === 'dashboard-page') loadDashboardData();
        else if (pageId === 'orders-page') loadOrders();
        else if (pageId === 'products-page') loadProducts();
        else if (pageId === 'locations-page') loadLocations();
    };

    function getStartOfWeek(date) {
        const dt = new Date(date.valueOf());
        const day = dt.getDay();
        const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(dt.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday;
    }

    function destroyChart(chartId) {
        if (window.chartInstances[chartId]) {
            window.chartInstances[chartId].destroy();
            delete window.chartInstances[chartId];
        }
    }

    function createOrUpdateChart(ctx, chartId, chartType, labels, datasets, options = {}) {
        destroyChart(chartId);
        if (ctx) {
            window.chartInstances[chartId] = new Chart(ctx, {
                type: chartType, data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-color)' }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { ticks: { color: 'var(--text-color)' }, grid: { color: 'rgba(0,0,0,0.05)' } } }, plugins: { legend: { labels: { color: 'var(--text-color)' } } }, ...options }
            });
        } else { console.error(`Contesto Canvas non trovato per ${chartId}`); }
    }

    window.loadDashboardData = function() {
        const loader = document.getElementById('dashboard-loader');
        const statsContainer = document.getElementById('dashboard-stats');
        const chartsSection = document.getElementById('charts-section');

        if (loader) loader.style.display = 'block';
        if (statsContainer) statsContainer.innerHTML = '';
        if (chartsSection) chartsSection.style.display = 'none'; // Nascondi finché i dati non sono pronti

        if (unsubscribeDashboardOrders) { // Rimuovi listener precedente per la dashboard
            unsubscribeDashboardOrders();
            unsubscribeDashboardOrders = null;
        }

        const ordersRef = ref(database, 'orders');
        unsubscribeDashboardOrders = onValue(ordersRef, (snapshot) => {
            const rawOrders = snapshot.val();
            const orders = rawOrders ? Object.values(rawOrders).map(order => ({...order, date: new Date(order.date)})) : [];
            
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const completedOrders = orders.filter(o => o.status === 'completed').length;
            const totalRevenue = orders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + (o.total || 0), 0);

            Promise.all([get(ref(database, 'products')), get(ref(database, 'locations'))]).then(([productsSnap, locationsSnap]) => {
                const productsCount = productsSnap.exists() ? Object.keys(productsSnap.val()).length : 0;
                const locationsCount = locationsSnap.exists() ? Object.keys(locationsSnap.val()).length : 0;
                const today = new Date(); today.setHours(0,0,0,0);
                const todayOrders = orders.filter(o => { const d = new Date(o.date); d.setHours(0,0,0,0); return d.getTime() === today.getTime(); }).length;

                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>${pendingOrders}</h3><p>Ordini in attesa</p></div>
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>${completedOrders}</h3><p>Ordini completati</p></div>
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>${todayOrders}</h3><p>Ordini di oggi</p></div>
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>€${totalRevenue.toFixed(2)}</h3><p>Incasso totale</p></div>
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>${productsCount}</h3><p>Prodotti attivi</p></div>
                            <div class="card" style="text-align: center; padding: 1rem;"><h3>${locationsCount}</h3><p>Postazioni totali</p></div>
                        </div>
                        <h3 style="margin-top: 2rem;">Ultimi Ordini (max 5)</h3>
                        <table><thead><tr><th>ID</th><th>Cliente</th><th>Totale</th><th>Stato</th><th>Data</th></tr></thead><tbody>
                        ${orders.sort((a,b) => b.date - a.date).slice(0,5).map(o => `<tr><td>${o.id}</td><td>${o.customer.name}</td><td>€${(o.total||0).toFixed(2)}</td><td><span class="order-status ${o.status}">${o.status}</span></td><td>${o.date.toLocaleString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</td></tr>`).join('')}
                        </tbody></table>`;
                }

                const weeklyData = {}, monthlyData = {}, yearlyData = {};
                const validOrders = orders.filter(o => o.status !== 'cancelled' && o.date);
                validOrders.forEach(o => {
                    const orderDate = o.date, revenue = o.total || 0, year = orderDate.getFullYear();
                    const startOfWeek = getStartOfWeek(orderDate);
                    const weeklyKey = `${startOfWeek.getFullYear()}-${String(startOfWeek.getMonth()+1).padStart(2,'0')}-${String(startOfWeek.getDate()).padStart(2,'0')}`;
                    weeklyData[weeklyKey] = weeklyData[weeklyKey] || { orders: 0, revenue: 0, dateObject: startOfWeek };
                    weeklyData[weeklyKey].orders++; weeklyData[weeklyKey].revenue += revenue;
                    const monthlyKey = `${year}-${String(orderDate.getMonth()+1).padStart(2,'0')}`;
                    monthlyData[monthlyKey] = monthlyData[monthlyKey] || { orders: 0, revenue: 0 };
                    monthlyData[monthlyKey].orders++; monthlyData[monthlyKey].revenue += revenue;
                    const yearlyKey = `${year}`;
                    yearlyData[yearlyKey] = yearlyData[yearlyKey] || { orders: 0, revenue: 0 };
                    yearlyData[yearlyKey].orders++; yearlyData[yearlyKey].revenue += revenue;
                });
                
                if (chartsSection) chartsSection.style.display = 'block';

                const sortedWeeklyKeys = Object.keys(weeklyData).sort((a,b) => weeklyData[a].dateObject - weeklyData[b].dateObject);
                const weeklyLabels = sortedWeeklyKeys.map(k => {const d=weeklyData[k].dateObject; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`});
                createOrUpdateChart(document.getElementById('weeklyOrdersChart')?.getContext('2d'), 'weeklyOrdersChart', 'line', weeklyLabels, [{ label: 'N. Ordini', data: sortedWeeklyKeys.map(k=>weeklyData[k].orders), borderColor: 'var(--primary-color)', backgroundColor:'rgba(90,111,65,0.2)', tension: 0.1, fill: true }]);
                createOrUpdateChart(document.getElementById('weeklyRevenueChart')?.getContext('2d'), 'weeklyRevenueChart', 'line', weeklyLabels, [{ label: 'Fatturato (€)', data: sortedWeeklyKeys.map(k=>weeklyData[k].revenue), borderColor: 'var(--accent-color)', backgroundColor:'rgba(164,188,123,0.2)', tension: 0.1, fill: true }], {scales:{y:{ticks:{callback:v=>'€'+v.toFixed(2)}}}});
                const monthlyLabels = Object.keys(monthlyData).sort();
                createOrUpdateChart(document.getElementById('monthlyOrdersChart')?.getContext('2d'), 'monthlyOrdersChart', 'bar', monthlyLabels, [{ label: 'N. Ordini', data: monthlyLabels.map(k=>monthlyData[k].orders), backgroundColor: 'var(--primary-light)' }]);
                createOrUpdateChart(document.getElementById('monthlyRevenueChart')?.getContext('2d'), 'monthlyRevenueChart', 'bar', monthlyLabels, [{ label: 'Fatturato (€)', data: monthlyLabels.map(k=>monthlyData[k].revenue), backgroundColor: 'var(--secondary-light)' }], {scales:{y:{ticks:{callback:v=>'€'+v.toFixed(2)}}}});
                const annualLabels = Object.keys(yearlyData).sort();
                createOrUpdateChart(document.getElementById('annualOrdersChart')?.getContext('2d'), 'annualOrdersChart', 'bar', annualLabels, [{ label: 'N. Ordini', data: annualLabels.map(k=>yearlyData[k].orders), backgroundColor: 'var(--primary-dark)' }]);
                createOrUpdateChart(document.getElementById('annualRevenueChart')?.getContext('2d'), 'annualRevenueChart', 'bar', annualLabels, [{ label: 'Fatturato (€)', data: annualLabels.map(k=>yearlyData[k].revenue), backgroundColor: 'var(--secondary-dark)' }], {scales:{y:{ticks:{callback:v=>'€'+v.toFixed(2)}}}});

                if (loader) loader.style.display = 'none';
            }).catch(err => { console.error("Errore fetch prodotti/postazioni:", err); if(loader) loader.style.display = 'none';});
        }, (error) => {
            console.error("Dashboard: Errore onValue ordini:", error);
            if (loader) loader.style.display = 'none';
            if (statsContainer) statsContainer.innerHTML = "<p class='error-message'>Errore caricamento dati dashboard.</p>";
            if (unsubscribeDashboardOrders) { unsubscribeDashboardOrders(); unsubscribeDashboardOrders = null;}
        });
    };

    window.loadOrders = function() {
        const loader = document.getElementById('orders-loader');
        const listEl = document.getElementById('ordersList');
        if(loader) loader.style.display = 'block';
        if(listEl) listEl.innerHTML = '';

        if (unsubscribeOrdersPage) { unsubscribeOrdersPage(); unsubscribeOrdersPage = null; }
        const ordersRef = ref(database, 'orders');
        unsubscribeOrdersPage = onValue(ordersRef, (snapshot) => {
            const data = snapshot.val();
            window.orders = data ? Object.entries(data).map(([k,v])=>({...v, firebaseKey:k, date:new Date(v.date)})) : [];
            window.orders.sort((a,b) => b.date - a.date);
            filterOrders();
            if(loader) loader.style.display = 'none';
        }, (err) => { console.error("Errore loadOrders:", err); if(listEl)listEl.innerHTML="<p class='error-message'>Errore caricamento ordini.</p>"; if(loader)loader.style.display='none'; if(unsubscribeOrdersPage){unsubscribeOrdersPage(); unsubscribeOrdersPage=null;}});
    };
    
    window.clearOrderFilters = function() {
        const statusFilter = document.getElementById('order-status-filter');
        const dateFilter = document.getElementById('order-date-filter');
        if(statusFilter) statusFilter.value = 'all';
        if(dateFilter) dateFilter.value = '';
        filterOrders();
    };

    window.filterOrders = function() {
        const status = document.getElementById('order-status-filter')?.value;
        const dateVal = document.getElementById('order-date-filter')?.value;
        let filtered = [...window.orders];
        if (status && status !== 'all') filtered = filtered.filter(o => o.status === status);
        if (dateVal) {
            const filterDate = new Date(dateVal); filterDate.setHours(0,0,0,0);
            filtered = filtered.filter(o => { const d=new Date(o.date); d.setHours(0,0,0,0); return d.getTime()===filterDate.getTime();});
        }
        displayOrders(filtered);
    };

    window.displayOrders = function(ordersToDisplay) {
        const listEl = document.getElementById('ordersList');
        if(!listEl) return;
        if (ordersToDisplay.length === 0) { listEl.innerHTML = '<p>Nessun ordine trovato.</p>'; return; }
        listEl.innerHTML = ordersToDisplay.map(o => {
            const statusTxt = o.status === 'pending' ? 'In attesa' : o.status === 'completed' ? 'Completato' : o.status === 'cancelled' ? 'Annullato' : o.status;
            return `<div class="order-card">
                <div class="order-header"><div class="order-id">Ordine #${o.id}</div><div class="order-date">${o.date.toLocaleString('it-IT',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div><span class="order-status ${o.status}">${statusTxt}</span></div>
                <div class="order-details"><div><strong>Cliente:</strong> ${o.customer.name} | <strong>Tel:</strong> ${o.customer.phone}</div><div><strong>Postazione:</strong> ${o.location.name} (Nr: ${o.location.number})</div><div><strong>Totale:</strong> €${(o.total||0).toFixed(2)}</div>${o.notes?`<div><strong>Note:</strong> ${o.notes}</div>`:''}</div>
                <div class="order-actions"><button onclick="viewOrderDetails('${o.firebaseKey}')">Dettagli</button>${o.status==='pending'?`<button onclick="updateOrderStatus('${o.firebaseKey}','completed')" style="background-color:var(--primary-dark);">Completa</button><button onclick="updateOrderStatus('${o.firebaseKey}','cancelled')" style="background-color:#c62828;">Annulla</button>`:''}</div>
            </div>`;
        }).join('');
    };

    window.viewOrderDetails = function(orderKey) {
        const order = window.orders.find(o => o.firebaseKey === orderKey);
        if (!order) return;
        const modal = document.getElementById('orderModal');
        const content = document.getElementById('orderModalContent');
        if(!modal || !content) return;
        const itemsHTML = (order.items && Array.isArray(order.items)) ? order.items.map(item => `<tr><td>${item.name||'N/D'}</td><td>${item.quantity||0}</td><td>€${(item.price||0).toFixed(2)}</td><td>€${((item.price||0)*(item.quantity||0)).toFixed(2)}</td></tr>`).join('') : '';
        content.innerHTML = `<p><strong>ID:</strong> ${order.id}</p><p><strong>Data:</strong> ${order.date.toLocaleString('it-IT')}</p><p><strong>Stato:</strong> <span class="order-status ${order.status}">${order.status}</span></p><h4>Cliente</h4><p>${order.customer.name}, ${order.customer.phone}</p><h4>Postazione</h4><p>${order.location.name} (#${order.location.number})</p><h4>Prodotti</h4><table><thead><tr><th>Prodotto</th><th>Q.tà</th><th>Prezzo U.</th><th>Totale</th></tr></thead><tbody>${itemsHTML}</tbody><tfoot><tr><td colspan="3" style="text-align:right;"><strong>Totale Ordine:</strong></td><td><strong>€${(order.total||0).toFixed(2)}</strong></td></tr></tfoot></table>${order.notes?`<h4>Note</h4><p>${order.notes}</p>`:''}${order.status==='pending'?`<div style="text-align:right;margin-top:1rem;"><button onclick="updateOrderStatus('${order.firebaseKey}','completed')" style="background-color:var(--primary-dark);">Completa</button><button onclick="updateOrderStatus('${order.firebaseKey}','cancelled')" style="background-color:#c62828;">Annulla</button></div>`:''}`;
        modal.style.display = 'block';
    };

    window.updateOrderStatus = function(orderKey, newStatus) {
        update(ref(database, `orders/${orderKey}`), {status: newStatus})
        .then(() => { if(document.getElementById('orderModal')) document.getElementById('orderModal').style.display='none'; alert(`Ordine ${newStatus}!`); })
        .catch(err => { console.error(err); alert("Errore aggiornamento stato.");});
    };

    window.loadProducts = function() {
        const loader = document.getElementById('products-loader');
        const listEl = document.getElementById('productsList');
        if(loader) loader.style.display = 'block';
        if(listEl) listEl.innerHTML = '';

        if (unsubscribeProductsPage) { unsubscribeProductsPage(); unsubscribeProductsPage = null; }
        const productsRef = ref(database, 'products');
        unsubscribeProductsPage = onValue(productsRef, (snapshot) => {
            const data = snapshot.val();
            window.products = data ? Object.entries(data).map(([k,v])=>({...v, firebaseKey:k})) : [];
            if(listEl) {
                if(window.products.length===0) listEl.innerHTML = "<p>Nessun prodotto.</p>";
                else listEl.innerHTML = `<table><thead><tr><th>ID</th><th>Nome</th><th>Desc.</th><th>Prezzo</th><th>Azioni</th></tr></thead><tbody>${window.products.map(p=>`<tr><td>${p.id}</td><td>${p.name}</td><td>${(p.description||'').substring(0,30)}...</td><td>€${(p.price||0).toFixed(2)}</td><td style="white-space:nowrap;"><button onclick="editProduct('${p.firebaseKey}')" style="background-color:#1976D2;margin-right:5px;">Mod.</button><button onclick="deleteProduct('${p.firebaseKey}')" style="background-color:#c62828;">Elim.</button></td></tr>`).join('')}</tbody></table>`;
            }
            if(loader) loader.style.display = 'none';
        }, (err) => { console.error("Errore loadProducts:", err); if(listEl)listEl.innerHTML="<p class='error-message'>Errore caricamento prodotti.</p>"; if(loader)loader.style.display='none'; if(unsubscribeProductsPage){unsubscribeProductsPage(); unsubscribeProductsPage=null;}});
    };
    
    window.showProductForm = function(isEdit = false, productKey = null) {
        const form = document.getElementById('product-form');
        const title = document.getElementById('product-form-title');
        const idEl = document.getElementById('product-id');
        const nameEl = document.getElementById('product-name');
        const descEl = document.getElementById('product-description');
        const priceEl = document.getElementById('product-price');
        const imgEl = document.getElementById('product-image');

        if (!form || !title || !idEl || !nameEl || !descEl || !priceEl || !imgEl) return;

        form.style.display = 'block';
        title.textContent = isEdit ? 'Modifica Prodotto' : 'Aggiungi Nuovo Prodotto';
        idEl.value = productKey || '';
        
        if (isEdit && productKey) {
            const p = window.products.find(prod => prod.firebaseKey === productKey);
            if (p) { nameEl.value = p.name; descEl.value = p.description; priceEl.value = p.price; imgEl.value = p.image; }
        } else { nameEl.value = ''; descEl.value = ''; priceEl.value = ''; imgEl.value = ''; }
    };
    window.editProduct = (key) => showProductForm(true, key);
    window.hideProductForm = () => { if(document.getElementById('product-form')) document.getElementById('product-form').style.display = 'none';};

    window.saveProduct = function() {
        const key = document.getElementById('product-id').value;
        const name = document.getElementById('product-name').value.trim();
        const desc = document.getElementById('product-description').value.trim();
        const price = parseFloat(document.getElementById('product-price').value);
        const image = document.getElementById('product-image').value.trim();
        if(!name){alert('Nome obbligatorio');return;} if(isNaN(price)||price<=0){alert('Prezzo non valido');return;}
        const data = {name,description:desc,price,image:image||`https://via.placeholder.com/300x200.png?text=${name.replace(/ /g,'+')}`};
        if(key){ data.id = window.products.find(p=>p.firebaseKey===key).id; update(ref(database,`products/${key}`),data).then(()=>alert('Aggiornato!')).catch(console.error); }
        else { data.id = window.products.length > 0 ? Math.max(0,...window.products.map(p=>parseInt(p.id)||0))+1 : 1; push(ref(database,'products'),data).then(()=>alert('Aggiunto!')).catch(console.error);}
        hideProductForm();
    };
    window.deleteProduct = (key) => { if(confirm('Eliminare prodotto?')) remove(ref(database,`products/${key}`)).then(()=>alert('Eliminato!')).catch(console.error);};

    window.loadLocations = function() {
        const loader = document.getElementById('locations-loader');
        const listEl = document.getElementById('locationsList');
        if(loader) loader.style.display = 'block';
        if(listEl) listEl.innerHTML = '';

        if (unsubscribeLocationsPage) { unsubscribeLocationsPage(); unsubscribeLocationsPage = null; }
        const locationsRef = ref(database, 'locations');
        unsubscribeLocationsPage = onValue(locationsRef, (snapshot) => {
            const data = snapshot.val();
            window.locations = data ? Object.entries(data).map(([k,v])=>({...v, firebaseKey:k})) : [];
            window.locations.sort((a,b)=>(parseInt(a.number)||0)-(parseInt(b.number)||0));
            if(listEl){
                if(window.locations.length===0) listEl.innerHTML = "<p>Nessuna postazione.</p>";
                else listEl.innerHTML = `<table><thead><tr><th>Num.</th><th>Nome</th><th>Stato</th><th>Azioni</th></tr></thead><tbody>${window.locations.map(l=>{ const sT=l.status==='available'?'Disponibile':l.status==='maintenance'?'Manutenzione':'Riservata'; const sC=l.status==='available'?'completed':l.status==='maintenance'?'cancelled':'pending'; return `<tr><td>${l.number}</td><td>${l.name}</td><td><span class="order-status ${sC}">${sT}</span></td><td style="white-space:nowrap;"><button onclick="editLocation('${l.firebaseKey}')" style="background-color:#1976D2;margin-right:5px;">Mod.</button><button onclick="deleteLocation('${l.firebaseKey}')" style="background-color:#c62828;">Elim.</button></td></tr>`;}).join('')}</tbody></table>`;
            }
            if(loader) loader.style.display = 'none';
        }, (err) => { console.error("Errore loadLocations:", err); if(listEl)listEl.innerHTML="<p class='error-message'>Errore caricamento postazioni.</p>"; if(loader)loader.style.display='none'; if(unsubscribeLocationsPage){unsubscribeLocationsPage(); unsubscribeLocationsPage=null;}});
    };
    window.showLocationForm = function(isEdit=false, key=null){
        const form = document.getElementById('location-form');
        const title = document.getElementById('location-form-title');
        const idEl = document.getElementById('location-id');
        const numEl = document.getElementById('location-number');
        const nameEl = document.getElementById('location-name');
        const statEl = document.getElementById('location-status');
        if(!form || !title || !idEl || !numEl || !nameEl || !statEl) return;
        form.style.display='block'; title.textContent=isEdit?'Modifica Postazione':'Aggiungi Postazione'; idEl.value=key||'';
        if(isEdit&&key){ const l=window.locations.find(loc=>loc.firebaseKey===key); if(l){numEl.value=l.number;nameEl.value=l.name;statEl.value=l.status||'available';}}
        else{numEl.value='';nameEl.value='';statEl.value='available';}
    };
    window.editLocation = (key) => showLocationForm(true, key);
    window.hideLocationForm = () => {if(document.getElementById('location-form')) document.getElementById('location-form').style.display = 'none';};
    window.saveLocation = function(){
        const key=document.getElementById('location-id').value;
        const num=parseInt(document.getElementById('location-number').value);
        const name=document.getElementById('location-name').value.trim();
        const status=document.getElementById('location-status').value;
        if(isNaN(num)||num<=0){alert('Numero non valido');return;} if(!name){alert('Nome obbligatorio');return;}
        if(window.locations.find(l=>l.number===num && l.firebaseKey!==key)){alert(`Postazione numero ${num} esiste già.`);return;}
        const data={number:num,name,status};
        if(key) update(ref(database,`locations/${key}`),data).then(()=>alert('Aggiornata!')).catch(console.error);
        else push(ref(database,'locations'),data).then(()=>alert('Aggiunta!')).catch(console.error);
        hideLocationForm();
    };
    window.deleteLocation = (key) => { if(confirm('Eliminare postazione?')) remove(ref(database,`locations/${key}`)).then(()=>alert('Eliminata!')).catch(console.error);};

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('isAdminLoggedIn') === 'true') {
            document.getElementById('login').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            showPage('dashboard-page');
        }
        const passInput = document.getElementById('password');
        if(passInput) passInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
    });
</script>
</body>
</html>
